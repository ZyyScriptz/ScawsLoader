if _G.KovariLoaded then
    warn("[Kovari] Library already loaded in this game session")
    return _G.KovariInstance
end
_G.KovariLoaded = true

local Kovari = {}
Kovari.__index = Kovari

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local MarketplaceService = game:GetService("MarketplaceService")
local TextService = game:GetService("TextService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Player
local LocalPlayer = Players.LocalPlayer
local Theme = {
    -- Backgrounds
    Primary = Color3.fromRGB(0, 0, 0),
    Secondary = Color3.fromRGB(18, 18, 20),
    Tertiary = Color3.fromRGB(28, 28, 32),
    Elevated = Color3.fromRGB(38, 38, 42),
    
    -- Interactive
    Fill = Color3.fromRGB(48, 48, 54),
    FillHover = Color3.fromRGB(58, 58, 66),
    FillPressed = Color3.fromRGB(68, 68, 76),
    
    -- Accent
    Accent = Color3.fromRGB(88, 86, 214),
    AccentLight = Color3.fromRGB(108, 106, 234),
    AccentDark = Color3.fromRGB(68, 66, 194),
    AccentMuted = Color3.fromRGB(88, 86, 214),
    
    -- Text
    TextPrimary = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(142, 142, 147),
    TextTertiary = Color3.fromRGB(99, 99, 102),
    TextDisabled = Color3.fromRGB(72, 72, 74),
    
    -- Semantic
    Success = Color3.fromRGB(52, 199, 89),
    Warning = Color3.fromRGB(255, 159, 10),
    Error = Color3.fromRGB(255, 69, 58),
    Info = Color3.fromRGB(10, 132, 255),
    
    -- Borders
    Border = Color3.fromRGB(44, 44, 48),
    BorderLight = Color3.fromRGB(54, 54, 58),
    Separator = Color3.fromRGB(38, 38, 42),
    
    -- Typography
    FontRegular = Enum.Font.GothamMedium,
    FontMedium = Enum.Font.GothamMedium,
    FontSemibold = Enum.Font.GothamSemibold,
    FontBold = Enum.Font.GothamBold,
    
    -- Sizing
    CornerRadius = 12,
    CornerRadiusSmall = 8,
    CornerRadiusLarge = 16,
    
    -- Animation (Improved timings)
    SpringSpeed = 0.3,
SpringSpeed = 0.25,  -- Faster spring
SpringDamping = 0.75,  -- Bouncier
QuickSpeed = 0.1,  -- Snappier
NormalSpeed = 0.18,  -- Faster normal
SlowSpeed = 0.3,  -- Faster slow
}

-- Utility Functions
local Util = {}

function Util.Create(className, properties)
    local instance = Instance.new(className)
    for key, value in pairs(properties or {}) do
        if key ~= "Parent" then
            pcall(function()
                instance[key] = value
            end)
        end
    end
    if properties and properties.Parent then
        instance.Parent = properties.Parent
    end
    return instance
end

function Util.Tween(object, properties, duration, style, direction)
    if not object then return end
    local tweenInfo = TweenInfo.new(
        duration or Theme.NormalSpeed,
        style or Enum.EasingStyle.Quint,
        direction or Enum.EasingDirection.Out
    )
    local tween = TweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

function Util.Spring(object, properties, speed, damping)
    if not object then return end
    local tweenInfo = TweenInfo.new(
        speed or Theme.SpringSpeed,
        Enum.EasingStyle.Back,
        Enum.EasingDirection.Out
    )
    local tween = TweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

function Util.Corner(parent, radius)
    return Util.Create("UICorner", {
        CornerRadius = UDim.new(0, radius or Theme.CornerRadius),
        Parent = parent
    })
end

function Util.Stroke(parent, color, thickness, transparency)
    return Util.Create("UIStroke", {
        Color = color or Theme.Border,
        Thickness = thickness or 1,
        Transparency = transparency or 0,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = parent
    })
end

function Util.Padding(parent, padding)
    local p = padding or 12
    return Util.Create("UIPadding", {
        PaddingTop = UDim.new(0, p),
        PaddingBottom = UDim.new(0, p),
        PaddingLeft = UDim.new(0, p),
        PaddingRight = UDim.new(0, p),
        Parent = parent
    })
end

function Util.Shadow(parent, offset, transparency)
    return Util.Create("ImageLabel", {
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, offset or 4),
        Size = UDim2.new(1, 30, 1, 30),
        BackgroundTransparency = 1,
        Image = "rbxassetid://5554236805",
        ImageColor3 = Color3.fromRGB(0, 0, 0),
        ImageTransparency = transparency or 0.5,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(23, 23, 277, 277),
        ZIndex = -1,
        Parent = parent
    })
end

function Util.Ripple(button)
    local ripple = Util.Create("Frame", {
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = 0.85,
        ZIndex = button.ZIndex + 1,
        Parent = button
    })
    Util.Corner(ripple, 100)
    
    local maxSize = math.max(button.AbsoluteSize.X, button.AbsoluteSize.Y) * 2.5
    Util.Tween(ripple, {
        Size = UDim2.new(0, maxSize, 0, maxSize),
        BackgroundTransparency = 1
    }, 0.5)
    
    task.delay(0.5, function()
        if ripple and ripple.Parent then
            ripple:Destroy()
        end
    end)
end

function Util.GetGameName()
    local success, name = pcall(function()
        return MarketplaceService:GetProductInfo(game.PlaceId).Name
    end)
    return success and name or "Unknown Game"
end

function Util.FormatDate(timestamp)
    local date = os.date("*t", timestamp)
    local months = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"}
    return string.format("%s %d, %d", months[date.month], date.day, date.year)
end

function Util.Lerp(a, b, t)
    return a + (b - a) * t
end

-- Animation Helpers
local Animate = {}

function Animate.FadeIn(object, duration, delay)
    delay = delay or 0
    duration = duration or Theme.NormalSpeed
    
    if object:IsA("Frame") or object:IsA("TextLabel") or object:IsA("TextButton") or object:IsA("TextBox") then
        local originalTransparency = object:GetAttribute("TargetBgTransparency") or 0
        object.BackgroundTransparency = 1
        
        task.delay(delay, function()
            Util.Tween(object, {BackgroundTransparency = originalTransparency}, duration)
        end)
    end
    
    if object:IsA("TextLabel") or object:IsA("TextButton") or object:IsA("TextBox") then
        local originalTextTransparency = object:GetAttribute("TargetTextTransparency") or 0
        object.TextTransparency = 1
        
        task.delay(delay, function()
            Util.Tween(object, {TextTransparency = originalTextTransparency}, duration)
        end)
    end
    
    if object:IsA("ImageLabel") or object:IsA("ImageButton") then
        local originalTransparency = object:GetAttribute("TargetImageTransparency") or 0
        object.ImageTransparency = 1
        
        task.delay(delay, function()
            Util.Tween(object, {ImageTransparency = originalTransparency}, duration)
        end)
    end
end

function Animate.SlideIn(object, direction, duration, delay)
    delay = delay or 0
    duration = duration or Theme.NormalSpeed
    direction = direction or "up"
    
    local originalPosition = object.Position
    local offsetY = direction == "up" and 20 or (direction == "down" and -20 or 0)
    local offsetX = direction == "left" and 20 or (direction == "right" and -20 or 0)
    
    object.Position = UDim2.new(
        originalPosition.X.Scale,
        originalPosition.X.Offset + offsetX,
        originalPosition.Y.Scale,
        originalPosition.Y.Offset + offsetY
    )
    
    task.delay(delay, function()
        Util.Spring(object, {Position = originalPosition}, duration)
    end)
end

function Animate.ScaleIn(object, duration, delay)
    delay = delay or 0
    duration = duration or Theme.SpringSpeed
    
    local originalSize = object.Size
    object.Size = UDim2.new(
        originalSize.X.Scale * 0.95,
        originalSize.X.Offset * 0.95,
        originalSize.Y.Scale * 0.95,
        originalSize.Y.Offset * 0.95
    )
    
    task.delay(delay, function()
        Util.Spring(object, {Size = originalSize}, duration)
    end)
end

-- SHA256 Implementation for Key System
local function CreateSHA256()
    local MOD = 2^32
    local MODM = MOD - 1
    
    local function memoize(f)
        local mt = {}
        local t = setmetatable({}, mt)
        function mt:__index(k)
            local v = f(k)
            t[k] = v
            return v
        end
        return t
    end
    
    local function make_bitop_uncached(t, m)
        local function bitop(a, b)
            local res, p = 0, 1
            while a ~= 0 and b ~= 0 do
                local am, bm = a % m, b % m
                res = res + t[am * m + bm] * p
                a = (a - am) / m
                b = (b - bm) / m
                p = p * m
            end
            res = res + (a + b) * p
            return res
        end
        return bitop
    end
    
    local function make_bitop(t)
        local op1 = make_bitop_uncached(t, 2^1)
        local op2 = memoize(function(a)
            return memoize(function(b)
                return op1(a, b)
            end)
        end)
        return function(a, b)
            return (op2[a % 2^32])[b % 2^32]
        end
    end
    
    local bxor1 = make_bitop({[0] = 0, [1] = 1, [2] = 1, [3] = 0})
    
    local function bxor(a, b, c, ...)
        local z = nil
        if b then
            a = a % MOD
            b = b % MOD
            z = bxor1(a, b)
            if c then z = bxor(z, c, ...) end
            return z
        elseif a then
            return a % MOD
        else
            return 0
        end
    end
    
    local function band(a, b, c, ...)
        local z
        if b then
            a = a % MOD
            b = b % MOD
            z = ((a + b) - bxor1(a, b)) / 2
            if c then z = band(z, c, ...) end
            return z
        elseif a then
            return a % MOD
        else
            return MODM
        end
    end
    
    local function bnot(x)
        return MODM - (x % MOD)
    end
    
    local function rshift1(a, disp)
        return math.floor(a % 2^32 / 2^disp)
    end
    
    local function rshift(x, disp)
        if disp > 31 or disp < -31 then return 0 end
        return rshift1(x % MOD, disp)
    end
    
    local function lshift(a, disp)
        if disp < 0 then return rshift(a, -disp) end
        return (a * 2^disp) % 2^32
    end
    
    local function rrotate(x, disp)
        x = x % MOD
        disp = disp % 32
        local low = band(x, 2^disp - 1)
        return rshift(x, disp) + lshift(low, 32 - disp)
    end
    
    local k = {
        0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5,
        0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
        0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3,
        0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
        0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc,
        0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
        0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7,
        0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
        0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13,
        0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
        0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3,
        0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
        0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5,
        0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
        0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208,
        0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2,
    }
    
    local function str2hexa(s)
        return (string.gsub(s, ".", function(c)
            return string.format("%02x", string.byte(c))
        end))
    end
    
    local function num2s(l, n)
        local s = ""
        for _ = 1, n do
            local rem = l % 256
            s = string.char(rem) .. s
            l = (l - rem) / 256
        end
        return s
    end
    
    local function s2num(s, i)
        local n = 0
        for j = i, i + 3 do
            n = n * 256 + string.byte(s, j)
        end
        return n
    end
    
    local function preproc(msg, len)
        local extra = 64 - ((len + 9) % 64)
        len = num2s(8 * len, 8)
        msg = msg .. "\128" .. string.rep("\0", extra) .. len
        return msg
    end
    
    local function initH256(H)
        H[1] = 0x6a09e667
        H[2] = 0xbb67ae85
        H[3] = 0x3c6ef372
        H[4] = 0xa54ff53a
        H[5] = 0x510e527f
        H[6] = 0x9b05688c
        H[7] = 0x1f83d9ab
        H[8] = 0x5be0cd19
        return H
    end
    
    local function digestblock(msg, i, H)
        local w = {}
        for j = 1, 16 do
            w[j] = s2num(msg, i + (j - 1) * 4)
        end
        for j = 17, 64 do
            local v = w[j - 15]
            local s0 = bxor(rrotate(v, 7), rrotate(v, 18), rshift(v, 3))
            v = w[j - 2]
            w[j] = w[j - 16] + s0 + w[j - 7] + bxor(rrotate(v, 17), rrotate(v, 19), rshift(v, 10))
        end
        
        local a, b, c, d, e, f, g, h = H[1], H[2], H[3], H[4], H[5], H[6], H[7], H[8]
        for j = 1, 64 do
            local s0 = bxor(rrotate(a, 2), rrotate(a, 13), rrotate(a, 22))
            local maj = bxor(band(a, b), band(a, c), band(b, c))
            local t2 = s0 + maj
            local s1 = bxor(rrotate(e, 6), rrotate(e, 11), rrotate(e, 25))
            local ch = bxor(band(e, f), band(bnot(e), g))
            local t1 = h + s1 + ch + k[j] + w[j]
            h, g, f, e, d, c, b, a = g, f, e, (d + t1) % MOD, c, b, a, (t1 + t2) % MOD
        end
        
        H[1] = (H[1] + a) % MOD
        H[2] = (H[2] + b) % MOD
        H[3] = (H[3] + c) % MOD
        H[4] = (H[4] + d) % MOD
        H[5] = (H[5] + e) % MOD
        H[6] = (H[6] + f) % MOD
        H[7] = (H[7] + g) % MOD
        H[8] = (H[8] + h) % MOD
    end
    
    return function(msg)
        msg = preproc(msg, #msg)
        local H = initH256({})
        for i = 1, #msg, 64 do
            digestblock(msg, i, H)
        end
        return str2hexa(
            num2s(H[1], 4) .. num2s(H[2], 4) .. num2s(H[3], 4) .. num2s(H[4], 4) ..
            num2s(H[5], 4) .. num2s(H[6], 4) .. num2s(H[7], 4) .. num2s(H[8], 4)
        )
    end
end

-- JSON Library
local function CreateJSON()
    local encode, decode
    
    local escape_char_map = {
        ["\\"] = "\\\\", ["\""] = "\\\"", ["\b"] = "\\b",
        ["\f"] = "\\f", ["\n"] = "\\n", ["\r"] = "\\r", ["\t"] = "\\t",
    }
    
    local function escape_char(c)
        return escape_char_map[c] or string.format("\\u%04x", c:byte())
    end
    
    local function encode_nil()
        return "null"
    end
    
    local function encode_table(val, stack)
        local res = {}
        stack = stack or {}
        if stack[val] then error("circular reference") end
        stack[val] = true
        
        if rawget(val, 1) ~= nil or next(val) == nil then
            for _, v in ipairs(val) do
                table.insert(res, encode(v, stack))
            end
            stack[val] = nil
            return "[" .. table.concat(res, ",") .. "]"
        else
            for k, v in pairs(val) do
                table.insert(res, encode(k, stack) .. ":" .. encode(v, stack))
            end
            stack[val] = nil
            return "{" .. table.concat(res, ",") .. "}"
        end
    end
    
    local function encode_string(val)
        return '"' .. val:gsub('[%z\1-\31\\"]', escape_char) .. '"'
    end
    
    local function encode_number(val)
        if val ~= val or val <= -math.huge or val >= math.huge then
            error("unexpected number value '" .. tostring(val) .. "'")
        end
        return string.format("%.14g", val)
    end
    
    local type_func_map = {
        ["nil"] = encode_nil,
        ["table"] = encode_table,
        ["string"] = encode_string,
        ["number"] = encode_number,
        ["boolean"] = tostring,
    }
    
    encode = function(val, stack)
        local t = type(val)
        local f = type_func_map[t]
        if f then return f(val, stack) end
        error("unexpected type '" .. t .. "'")
    end
    
    local parse
    
    local function create_set(...)
        local res = {}
        for i = 1, select("#", ...) do
            res[select(i, ...)] = true
        end
        return res
    end
    
    local space_chars = create_set(" ", "\t", "\r", "\n")
    local delim_chars = create_set(" ", "\t", "\r", "\n", "]", "}", ",")
    local escape_chars = create_set("\\", "/", '"', "b", "f", "n", "r", "t", "u")
    local literals = create_set("true", "false", "null")
    local literal_map = {["true"] = true, ["false"] = false, ["null"] = nil}
    
    local function next_char(str, idx, set, negate)
        for i = idx, #str do
            if set[str:sub(i, i)] ~= negate then
                return i
            end
        end
        return #str + 1
    end
    
    local function decode_error(str, idx, msg)
        local line_count, col_count = 1, 1
        for i = 1, idx - 1 do
            col_count = col_count + 1
            if str:sub(i, i) == "\n" then
                line_count = line_count + 1
                col_count = 1
            end
        end
        error(string.format("%s at line %d col %d", msg, line_count, col_count))
    end
    
    local function codepoint_to_utf8(n)
        local f = math.floor
        if n <= 0x7f then
            return string.char(n)
        elseif n <= 0x7ff then
            return string.char(f(n / 64) + 192, n % 64 + 128)
        elseif n <= 0xffff then
            return string.char(f(n / 4096) + 224, f(n % 4096 / 64) + 128, n % 64 + 128)
        elseif n <= 0x10ffff then
            return string.char(f(n / 262144) + 240, f(n % 262144 / 4096) + 128, f(n % 4096 / 64) + 128, n % 64 + 128)
        end
        error(string.format("invalid unicode codepoint '%x'", n))
    end
    
    local function parse_unicode_escape(s)
        local n1 = tonumber(s:sub(1, 4), 16)
        local n2 = tonumber(s:sub(7, 10), 16)
        if n2 then
            return codepoint_to_utf8((n1 - 0xd800) * 0x400 + n2 - 0xdc00 + 0x10000)
        else
            return codepoint_to_utf8(n1)
        end
    end
    
    local function parse_string(str, i)
        local res = ""
        local j = i + 1
        local k = j
        
        while j <= #str do
            local x = str:byte(j)
            if x < 32 then
                decode_error(str, j, "control character in string")
            elseif x == 92 then
                res = res .. str:sub(k, j - 1)
                j = j + 1
                local c = str:sub(j, j)
                if c == "u" then
                    local hex = str:match("^[dD][89aAbB]%x%x\\u%x%x%x%x", j + 1) or str:match("^%x%x%x%x", j + 1)
                    if not hex then decode_error(str, j - 1, "invalid unicode escape in string") end
                    res = res .. parse_unicode_escape(hex)
                    j = j + #hex
                else
                    if not escape_chars[c] then
                        decode_error(str, j - 1, "invalid escape char '" .. c .. "' in string")
                    end
                    res = res .. (({b = "\b", f = "\f", n = "\n", r = "\r", t = "\t"})[c] or c)
                end
                k = j + 1
            elseif x == 34 then
                res = res .. str:sub(k, j - 1)
                return res, j + 1
            end
            j = j + 1
        end
        decode_error(str, i, "expected closing quote for string")
    end
    
    local function parse_number(str, i)
        local x = next_char(str, i, delim_chars)
        local s = str:sub(i, x - 1)
        local n = tonumber(s)
        if not n then decode_error(str, i, "invalid number '" .. s .. "'") end
        return n, x
    end
    
    local function parse_literal(str, i)
        local x = next_char(str, i, delim_chars)
        local word = str:sub(i, x - 1)
        if not literals[word] then decode_error(str, i, "invalid literal '" .. word .. "'") end
        return literal_map[word], x
    end
    
    local function parse_array(str, i)
        local res = {}
        local n = 1
        i = i + 1
        while true do
            local x
            i = next_char(str, i, space_chars, true)
            if str:sub(i, i) == "]" then
                i = i + 1
                break
            end
            x, i = parse(str, i)
            res[n] = x
            n = n + 1
            i = next_char(str, i, space_chars, true)
            local chr = str:sub(i, i)
            i = i + 1
            if chr == "]" then break end
            if chr ~= "," then decode_error(str, i, "expected ']' or ','") end
        end
        return res, i
    end
    
    local function parse_object(str, i)
        local res = {}
        i = i + 1
        while true do
            local key, val
            i = next_char(str, i, space_chars, true)
            if str:sub(i, i) == "}" then
                i = i + 1
                break
            end
            if str:sub(i, i) ~= '"' then decode_error(str, i, "expected string for key") end
            key, i = parse(str, i)
            i = next_char(str, i, space_chars, true)
            if str:sub(i, i) ~= ":" then decode_error(str, i, "expected ':' after key") end
            i = next_char(str, i + 1, space_chars, true)
            val, i = parse(str, i)
            res[key] = val
            i = next_char(str, i, space_chars, true)
            local chr = str:sub(i, i)
            i = i + 1
            if chr == "}" then break end
            if chr ~= "," then decode_error(str, i, "expected '}' or ','") end
        end
        return res, i
    end
    
    local char_func_map = {
        ['"'] = parse_string,
        ["0"] = parse_number, ["1"] = parse_number, ["2"] = parse_number,
        ["3"] = parse_number, ["4"] = parse_number, ["5"] = parse_number,
        ["6"] = parse_number, ["7"] = parse_number, ["8"] = parse_number,
        ["9"] = parse_number, ["-"] = parse_number,
        ["t"] = parse_literal, ["f"] = parse_literal, ["n"] = parse_literal,
        ["["] = parse_array, ["{"] = parse_object,
    }
    
    parse = function(str, idx)
        local chr = str:sub(idx, idx)
        local f = char_func_map[chr]
        if f then return f(str, idx) end
        decode_error(str, idx, "unexpected character '" .. chr .. "'")
    end
    
    decode = function(str)
        if type(str) ~= "string" then
            error("expected argument of type string, got " .. type(str))
        end
        local res, idx = parse(str, next_char(str, 1, space_chars, true))
        idx = next_char(str, idx, space_chars, true)
        if idx <= #str then decode_error(str, idx, "trailing garbage") end
        return res
    end
    
    return {encode = encode, decode = decode}
end

local SHA256 = CreateSHA256()
local JSON = CreateJSON()

-- Key System Handler
local KeySystemHandler = {}

function KeySystemHandler.new(config)
    local self = setmetatable({}, {__index = KeySystemHandler})
    
    self.ServiceId = config.ServiceId or 0
    self.Secret = config.Secret or ""
    self.UseNonce = config.UseNonce ~= false
    self.Host = "https://api.platoboost.com"
    self.CachedLink = ""
    self.CachedTime = 0
    self.RequestPending = false
    
    pcall(function()
        local response = (request or http_request or syn_request or function()
            return {StatusCode = 0}
        end)({
            Url = self.Host .. "/public/connectivity",
            Method = "GET"
        })
        if response.StatusCode ~= 200 and response.StatusCode ~= 429 then
            self.Host = "https://api.platoboost.net"
        end
    end)
    
    return self
end

function KeySystemHandler:GetHWID()
    local getHwid = gethwid or function()
        return tostring(LocalPlayer.UserId)
    end
    return getHwid()
end

function KeySystemHandler:GenerateNonce()
    local chars = "abcdefghijklmnopqrstuvwxyz"
    local result = ""
    for _ = 1, 16 do
        local idx = math.random(1, #chars)
        result = result .. chars:sub(idx, idx)
    end
    return result
end

function KeySystemHandler:Request(options)
    local requestFunc = request or http_request or syn_request or function()
        return {StatusCode = 0}
    end
    return pcall(function()
        return requestFunc(options)
    end)
end

function KeySystemHandler:GetKeyLink()
    if self.CachedTime + 600 > os.time() then
        return true, self.CachedLink
    end
    
    local success, response = self:Request({
        Url = self.Host .. "/public/start",
        Method = "POST",
        Body = JSON.encode({
            service = self.ServiceId,
            identifier = SHA256(self:GetHWID())
        }),
        Headers = {
            ["Content-Type"] = "application/json"
        }
    })
    
    if success and response.StatusCode == 200 then
        local data = JSON.decode(response.Body)
        if data.success then
            self.CachedLink = data.data.url
            self.CachedTime = os.time()
            return true, self.CachedLink
        end
        return false, data.message or "Failed to get link"
    elseif success and response.StatusCode == 429 then
        return false, "Rate limited. Please wait."
    end
    
    return false, "Connection failed"
end

function KeySystemHandler:CopyLink()
    local success, link = self:GetKeyLink()
    if success then
        pcall(function()
            (setclipboard or toclipboard or function() end)(link)
        end)
        return true
    end
    return false
end

function KeySystemHandler:RedeemKey(key)
    local nonce = self:GenerateNonce()
    local body = {
        identifier = SHA256(self:GetHWID()),
        key = key
    }
    if self.UseNonce then
        body.nonce = nonce
    end
    
    local success, response = self:Request({
        Url = self.Host .. "/public/redeem/" .. tostring(self.ServiceId),
        Method = "POST",
        Body = JSON.encode(body),
        Headers = {["Content-Type"] = "application/json"}
    })
    
    if success and response.StatusCode == 200 then
        local data = JSON.decode(response.Body)
        if data.success and data.data.valid then
            if self.UseNonce then
                return data.data.hash == SHA256("true-" .. nonce .. "-" .. self.Secret)
            end
            return true
        end
    end
    return false
end

function KeySystemHandler:VerifyKey(key)
    if self.RequestPending then
        return false, "Please wait..."
    end
    self.RequestPending = true
    
    local nonce = self:GenerateNonce()
    local endpoint = self.Host .. "/public/whitelist/" .. tostring(self.ServiceId)
    endpoint = endpoint .. "?identifier=" .. SHA256(self:GetHWID()) .. "&key=" .. key
    if self.UseNonce then
        endpoint = endpoint .. "&nonce=" .. nonce
    end
    
    local success, response = self:Request({
        Url = endpoint,
        Method = "GET"
    })
    
    self.RequestPending = false
    
    if success and response.StatusCode == 200 then
        local data = JSON.decode(response.Body)
        if data.success then
            if data.data.valid then
                if self.UseNonce then
                    local valid = data.data.hash == SHA256("true-" .. nonce .. "-" .. self.Secret)
                    return valid, valid and "Key verified!" or "Verification failed"
                end
                return true, "Key verified!"
            else
                if key:sub(1, 4) == "KEY_" then
                    local redeemed = self:RedeemKey(key)
                    return redeemed, redeemed and "Key redeemed!" or "Failed to redeem"
                end
                return false, "Invalid key"
            end
        end
        return false, data.message or "Verification failed"
    elseif success and response.StatusCode == 429 then
        return false, "Rate limited. Please wait."
    end
    
    return false, "Connection error"
end

-- Key System UI (Fixed animations and colors)
function Kovari:CreateKeyUI(config)
    config = config or {}
    
    local keyHandler = KeySystemHandler.new({
        ServiceId = config.ServiceId or 18623,
        Secret = config.Secret or "80e22eb6-80a9-44d1-9a87-0083e3dccadf",
        UseNonce = config.UseNonce
    })
    
    local title = config.Title or "KOVARI"
    local subtitle = config.Subtitle or "Key System"
    local discordLink = config.Discord or "discord.gg/QcvddpVeTM"
    local onSuccess = config.OnSuccess or function() end
    local onFailed = config.OnFailed or function() end
    
    -- Create ScreenGui
    local ScreenGui = Util.Create("ScreenGui", {
        Name = "KovariKeySystem",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        IgnoreGuiInset = true
    })
    
    pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(ScreenGui)
            ScreenGui.Parent = CoreGui
        elseif gethui then
            ScreenGui.Parent = gethui()
        else
            ScreenGui.Parent = CoreGui
        end
    end)
    
    -- Blur Background
    local Blur = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(0, 0, 0),
        BackgroundTransparency = 0.4,
        Parent = ScreenGui
    })
    
    -- Main Container (Start visible with proper colors)
    local MainFrame = Util.Create("Frame", {
        Name = "Main",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 400, 0, 340),
        BackgroundColor3 = Theme.Secondary,
        ClipsDescendants = true,
        Parent = ScreenGui
    })
    Util.Corner(MainFrame, Theme.CornerRadiusLarge)
    local MainStroke = Util.Stroke(MainFrame, Theme.Border, 1)
    local MainShadow = Util.Shadow(MainFrame, 6, 0.5)
    
    -- Header
    local Header = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 80),
        BackgroundColor3 = Theme.Tertiary,
        Parent = MainFrame
    })
    Util.Corner(Header, Theme.CornerRadiusLarge)
    
    local HeaderBottom = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 16),
        Position = UDim2.new(0, 0, 1, -16),
        BackgroundColor3 = Theme.Tertiary,
        BorderSizePixel = 0,
        Parent = Header
    })
    
    local HeaderDivider = Util.Create("Frame", {
        Size = UDim2.new(1, -32, 0, 1),
        Position = UDim2.new(0, 16, 1, 0),
        BackgroundColor3 = Theme.Separator,
        BorderSizePixel = 0,
        Parent = Header
    })
    
    -- Logo
    local LogoContainer = Util.Create("Frame", {
        Size = UDim2.new(0, 48, 0, 48),
        Position = UDim2.new(0, 20, 0.5, -24),
        BackgroundColor3 = Theme.Accent,
        Parent = Header
    })
    Util.Corner(LogoContainer, 10)
    
    local LogoIcon = Util.Create("ImageLabel", {
        Size = UDim2.new(1, -8, 1, -8),
        Position = UDim2.new(0, 4, 0, 4),
        BackgroundTransparency = 1,
        Image = "rbxassetid://104988871729944",
        ScaleType = Enum.ScaleType.Fit,
        Parent = LogoContainer
    })
    Util.Corner(LogoIcon, 6)
    
    -- Title
    local TitleLabel = Util.Create("TextLabel", {
        Size = UDim2.new(0, 200, 0, 22),
        Position = UDim2.new(0, 80, 0, 22),
        BackgroundTransparency = 1,
        Font = Theme.FontBold,
        Text = title,
        TextColor3 = Theme.TextPrimary,
        TextSize = 18,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = Header
    })
    
    local SubtitleLabel = Util.Create("TextLabel", {
        Size = UDim2.new(0, 200, 0, 16),
        Position = UDim2.new(0, 80, 0, 46),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        Text = subtitle,
        TextColor3 = Theme.TextSecondary,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = Header
    })
    
    -- Content
    local Content = Util.Create("Frame", {
        Size = UDim2.new(1, -32, 1, -100),
        Position = UDim2.new(0, 16, 0, 88),
        BackgroundTransparency = 1,
        Parent = MainFrame
    })
    
    -- Key Input Section
    local InputSection = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 80),
        BackgroundColor3 = Theme.Tertiary,
        Parent = Content
    })
    Util.Corner(InputSection, Theme.CornerRadius)
    local InputStroke = Util.Stroke(InputSection, Theme.Border, 1)
    
    local InputLabel = Util.Create("TextLabel", {
        Size = UDim2.new(1, -24, 0, 20),
        Position = UDim2.new(0, 12, 0, 10),
        BackgroundTransparency = 1,
        Font = Theme.FontSemibold,
        Text = "Enter Your Key",
        TextColor3 = Theme.TextPrimary,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = InputSection
    })
    
    local InputBox = Util.Create("Frame", {
        Size = UDim2.new(1, -24, 0, 36),
        Position = UDim2.new(0, 12, 0, 34),
        BackgroundColor3 = Theme.Fill,
        Parent = InputSection
    })
    Util.Corner(InputBox, Theme.CornerRadiusSmall)
    local InputBoxStroke = Util.Stroke(InputBox, Theme.Border, 1)
    
    local KeyInput = Util.Create("TextBox", {
        Size = UDim2.new(1, -20, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        PlaceholderText = "Paste your key here...",
        PlaceholderColor3 = Theme.TextTertiary,
        Text = "",
        TextColor3 = Theme.TextPrimary,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = InputBox
    })
    
    -- Status
    local StatusLabel = Util.Create("TextLabel", {
        Size = UDim2.new(1, 0, 0, 20),
        Position = UDim2.new(0, 0, 0, 88),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        Text = "",
        TextColor3 = Theme.TextSecondary,
        TextSize = 11,
        Parent = Content
    })
    
    -- Buttons
    local ButtonContainer = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 40),
        Position = UDim2.new(0, 0, 0, 112),
        BackgroundTransparency = 1,
        Parent = Content
    })
    
    local VerifyButton = Util.Create("TextButton", {
        Size = UDim2.new(0.48, 0, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = Theme.Accent,
        Font = Theme.FontSemibold,
        Text = "Verify Key",
        TextColor3 = Theme.TextPrimary,
        TextSize = 13,
        AutoButtonColor = false,
        ClipsDescendants = true,
        Parent = ButtonContainer
    })
    Util.Corner(VerifyButton, Theme.CornerRadiusSmall)
    
    local GetKeyButton = Util.Create("TextButton", {
        AnchorPoint = Vector2.new(1, 0),
        Size = UDim2.new(0.48, 0, 1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        BackgroundColor3 = Theme.Fill,
        Font = Theme.FontSemibold,
        Text = "Get Key",
        TextColor3 = Theme.TextPrimary,
        TextSize = 13,
        AutoButtonColor = false,
        ClipsDescendants = true,
        Parent = ButtonContainer
    })
    Util.Corner(GetKeyButton, Theme.CornerRadiusSmall)
    local GetKeyStroke = Util.Stroke(GetKeyButton, Theme.Border, 1)
    
    -- Discord Section
    local DiscordSection = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 44),
        Position = UDim2.new(0, 0, 0, 160),
        BackgroundColor3 = Theme.Tertiary,
        Parent = Content
    })
    Util.Corner(DiscordSection, Theme.CornerRadius)
    local DiscordStroke = Util.Stroke(DiscordSection, Theme.Border, 1)
    
    local DiscordIcon = Util.Create("TextLabel", {
        Size = UDim2.new(0, 30, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        Text = "HELP",
        TextColor3 = Theme.TextTertiary,
        TextSize = 8,
        Parent = DiscordSection
    })
    
    local DiscordText = Util.Create("TextLabel", {
        Size = UDim2.new(0, 100, 1, 0),
        Position = UDim2.new(0, 44, 0, 0),
        BackgroundTransparency = 1,
        Font = Theme.FontSemibold,
        Text = "Need help?",
        TextColor3 = Theme.TextPrimary,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = DiscordSection
    })
    
    local DiscordButton = Util.Create("TextButton", {
        AnchorPoint = Vector2.new(1, 0.5),
        Size = UDim2.new(0, 100, 0, 28),
        Position = UDim2.new(1, -10, 0.5, 0),
        BackgroundColor3 = Theme.Fill,
        Font = Theme.FontSemibold,
        Text = "Join Discord",
        TextColor3 = Theme.TextPrimary,
        TextSize = 11,
        AutoButtonColor = false,
        Parent = DiscordSection
    })
    Util.Corner(DiscordButton, Theme.CornerRadiusSmall)
    local DiscordBtnStroke = Util.Stroke(DiscordButton, Theme.Border, 1)
    
    -- Footer
    local FooterLabel = Util.Create("TextLabel", {
        Size = UDim2.new(1, 0, 0, 16),
        Position = UDim2.new(0, 0, 1, -20),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        Text = "Keys are valid for 24 hours after activation",
        TextColor3 = Theme.TextTertiary,
        TextSize = 10,
        Parent = Content
    })
    
    -- Connections Storage
    local Connections = {}
    
    -- Dragging
    local dragging = false
    local dragStart, startPos
    local targetPos = MainFrame.Position
    
    table.insert(Connections, Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end))
    
    table.insert(Connections, Header.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end))
    
    table.insert(Connections, UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            targetPos = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end))
    
    table.insert(Connections, RunService.RenderStepped:Connect(function()
        if dragging then
            MainFrame.Position = MainFrame.Position:Lerp(targetPos, 0.15)
        end
    end))
    
    -- Input Focus Effects
    table.insert(Connections, KeyInput.Focused:Connect(function()
        Util.Tween(InputBox, {BackgroundColor3 = Theme.FillHover}, Theme.QuickSpeed)
        Util.Tween(InputBoxStroke, {Color = Theme.Accent}, Theme.QuickSpeed)
    end))
    
    table.insert(Connections, KeyInput.FocusLost:Connect(function()
        Util.Tween(InputBox, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
        Util.Tween(InputBoxStroke, {Color = Theme.Border}, Theme.QuickSpeed)
    end))
    
    -- Button Hover Effects
    local function SetupButton(button, isPrimary, stroke)
        local hovered, pressed = false, false
        
        local function UpdateState()
            local targetColor
            if pressed then
                targetColor = isPrimary and Theme.AccentDark or Theme.FillPressed
            elseif hovered then
                targetColor = isPrimary and Theme.AccentLight or Theme.FillHover
            else
                targetColor = isPrimary and Theme.Accent or Theme.Fill
            end
            Util.Tween(button, {BackgroundColor3 = targetColor}, Theme.QuickSpeed)
        end
        
        table.insert(Connections, button.MouseEnter:Connect(function()
            hovered = true
            UpdateState()
        end))
        
        table.insert(Connections, button.MouseLeave:Connect(function()
            hovered = false
            pressed = false
            UpdateState()
        end))
        
        table.insert(Connections, button.MouseButton1Down:Connect(function()
            pressed = true
            UpdateState()
        end))
        
        table.insert(Connections, button.MouseButton1Up:Connect(function()
            pressed = false
            UpdateState()
        end))
    end
    
    SetupButton(VerifyButton, true)
    SetupButton(GetKeyButton, false, GetKeyStroke)
    SetupButton(DiscordButton, false, DiscordBtnStroke)
    
    -- Status Function
    local function SetStatus(text, color)
        StatusLabel.Text = text
        StatusLabel.TextColor3 = color or Theme.TextSecondary
    end
    
    -- Close Function
    local function Close()
        for _, conn in ipairs(Connections) do
            conn:Disconnect()
        end
        
        Util.Tween(Blur, {BackgroundTransparency = 1}, Theme.NormalSpeed)
        Util.Tween(MainShadow, {ImageTransparency = 1}, Theme.QuickSpeed)
        Util.Tween(MainStroke, {Transparency = 1}, Theme.QuickSpeed)
        Util.Tween(MainFrame, {
            BackgroundTransparency = 1,
            Size = UDim2.new(0, 380, 0, 320)
        }, Theme.NormalSpeed)
        
        for _, child in ipairs(MainFrame:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                Util.Tween(child, {TextTransparency = 1}, Theme.QuickSpeed)
            end
            if child:IsA("Frame") and child.BackgroundTransparency < 1 then
                Util.Tween(child, {BackgroundTransparency = 1}, Theme.QuickSpeed)
            end
            if child:IsA("ImageLabel") then
                Util.Tween(child, {ImageTransparency = 1}, Theme.QuickSpeed)
            end
            if child:IsA("UIStroke") then
                Util.Tween(child, {Transparency = 1}, Theme.QuickSpeed)
            end
        end
        
        task.delay(Theme.NormalSpeed + 0.1, function()
            ScreenGui:Destroy()
        end)
    end
    
    -- Button Callbacks
    table.insert(Connections, VerifyButton.MouseButton1Click:Connect(function()
        Util.Ripple(VerifyButton)
        local key = KeyInput.Text
        
        if key == "" then
            SetStatus("Please enter a key", Theme.Warning)
            return
        end
        
        SetStatus("Verifying...", Theme.TextSecondary)
        VerifyButton.Text = "..."
        
        task.spawn(function()
            local success, message = keyHandler:VerifyKey(key)
            
            if success then
                SetStatus(message, Theme.Success)
                VerifyButton.Text = "Success!"
                Util.Tween(VerifyButton, {BackgroundColor3 = Theme.Success}, Theme.QuickSpeed)
                
                task.delay(1.2, function()
                    Close()
                    task.delay(0.4, onSuccess)
                end)
            else
                SetStatus(message, Theme.Error)
                VerifyButton.Text = "Verify Key"
                Util.Tween(VerifyButton, {BackgroundColor3 = Theme.Error}, Theme.QuickSpeed)
                task.delay(1.5, function()
                    Util.Tween(VerifyButton, {BackgroundColor3 = Theme.Accent}, Theme.QuickSpeed)
                end)
                onFailed(message)
            end
        end)
    end))
    
    table.insert(Connections, GetKeyButton.MouseButton1Click:Connect(function()
        Util.Ripple(GetKeyButton)
        SetStatus("Getting link...", Theme.TextSecondary)
        
        task.spawn(function()
            local success = keyHandler:CopyLink()
            if success then
                SetStatus("Link copied to clipboard!", Theme.Success)
                GetKeyButton.Text = "Copied!"
                task.delay(2, function()
                    GetKeyButton.Text = "Get Key"
                    SetStatus("", Theme.TextSecondary)
                end)
            else
                SetStatus("Failed to get link", Theme.Error)
            end
        end)
    end))
    
    table.insert(Connections, DiscordButton.MouseButton1Click:Connect(function()
        Util.Ripple(DiscordButton)
        pcall(function()
            (setclipboard or toclipboard or function() end)(discordLink)
        end)
        DiscordButton.Text = "Copied!"
        task.delay(1.5, function()
            DiscordButton.Text = "Join Discord"
        end)
    end))
    
    return {
        Destroy = Close,
        SetStatus = SetStatus
    }
end

Kovari.Util = Util
Kovari.Theme = Theme
Kovari.Animate = Animate
Kovari.JSON = JSON

-- Store instance globally
_G.KovariInstance = Kovari
--[[
    Kovari UI Library - Fixed & Improved Version
    Part 2 of 2: Main UI System, Tabs, Components
    
    This continues from Part 1 - append this code to Part 1
]]

-- Main UI Initialization
function Kovari:Init(config)
    config = config or {}
    
    local toggleKey = config.ToggleKey or Enum.KeyCode.RightControl
    local discordInvite = config.Discord or "discord.gg/QcvddpVeTM"
    
    local Theme = self.Theme
    local Util = self.Util
    local Animate = self.Animate
    
    -- State
    local AllTabs = {}
    local CurrentTab = nil
    local UIVisible = true
    local Toggling = false
    local UIScaleValue = 100
    local Connections = {}
    
    -- Create ScreenGui
    local ScreenGui = Util.Create("ScreenGui", {
        Name = "KovariUI",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        IgnoreGuiInset = true
    })
    
    pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(ScreenGui)
            ScreenGui.Parent = CoreGui
        elseif gethui then
            ScreenGui.Parent = gethui()
        else
            ScreenGui.Parent = CoreGui
        end
    end)
    
    -- UI Scale
    local UIScale = Util.Create("UIScale", {
        Scale = 1,
        Parent = ScreenGui
    })
    
    -- Main Frame (Start with proper colors, not transparent)
    local Main = Util.Create("Frame", {
        Name = "Main",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 580, 0, 380),
        BackgroundColor3 = Theme.Primary,
        ClipsDescendants = true,
        Parent = ScreenGui
    })
    Util.Corner(Main, Theme.CornerRadiusLarge)
    local MainStroke = Util.Stroke(Main, Theme.Border, 1)
    local MainShadow = Util.Shadow(Main, 6, 0.5)
    
    -- Top Bar
    local TopBar = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 52),
        BackgroundColor3 = Theme.Secondary,
        Parent = Main
    })
    Util.Corner(TopBar, Theme.CornerRadiusLarge)
    
    local TopBarBottom = Util.Create("Frame", {
        Size = UDim2.new(1, 0, 0, 12),
        Position = UDim2.new(0, 0, 1, -12),
        BackgroundColor3 = Theme.Secondary,
        BorderSizePixel = 0,
        Parent = TopBar
    })
    
    local TopBarDivider = Util.Create("Frame", {
        Size = UDim2.new(1, -28, 0, 1),
        Position = UDim2.new(0, 14, 1, 0),
        BackgroundColor3 = Theme.Separator,
        BorderSizePixel = 0,
        Parent = TopBar
    })
    
    -- Logo
    local LogoFrame = Util.Create("Frame", {
        Size = UDim2.new(0, 32, 0, 32),
        Position = UDim2.new(0, 14, 0.5, -16),
        BackgroundColor3 = Theme.Accent,
        Parent = TopBar
    })
    Util.Corner(LogoFrame, 8)
    
    local LogoImage = Util.Create("ImageLabel", {
        Size = UDim2.new(1, -6, 1, -6),
        Position = UDim2.new(0, 3, 0, 3),
        BackgroundTransparency = 1,
        Image = "rbxassetid://104988871729944",
        ScaleType = Enum.ScaleType.Fit,
        Parent = LogoFrame
    })
    
    local TitleLabel = Util.Create("TextLabel", {
        Size = UDim2.new(0, 80, 0, 20),
        Position = UDim2.new(0, 54, 0.5, -10),
        BackgroundTransparency = 1,
        Font = Theme.FontBold,
        Text = "KOVARI",
        TextColor3 = Theme.TextPrimary,
        TextSize = 15,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = TopBar
    })
    
    -- Status Indicator
    local StatusContainer = Util.Create("Frame", {
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, -14, 0.5, 0),
        Size = UDim2.new(0, 180, 0, 32),
        BackgroundTransparency = 1,
        Parent = TopBar
    })
    
    local StatusDot = Util.Create("Frame", {
        AnchorPoint = Vector2.new(1, 0.5),
        Size = UDim2.new(0, 7, 0, 7),
        Position = UDim2.new(1, 0, 0.5, 6),
        BackgroundColor3 = Theme.Success,
        Parent = StatusContainer
    })
    Util.Corner(StatusDot, 4)
    
    local StatusText = Util.Create("TextLabel", {
        AnchorPoint = Vector2.new(1, 0),
        Size = UDim2.new(1, -12, 0, 14),
        Position = UDim2.new(1, -12, 0.5, 0),
        BackgroundTransparency = 1,
        Font = Theme.FontRegular,
        Text = "Connected",
        TextColor3 = Theme.Success,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = StatusContainer
    })
    
    local GameLabel = Util.Create("TextLabel", {
        AnchorPoint = Vector2.new(1, 1),
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(1, 0, 0.5, -2),
        BackgroundTransparency = 1,
        Font = Theme.FontSemibold,
        Text = Util.GetGameName(),
        TextColor3 = Theme.TextPrimary,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Right,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = StatusContainer
    })
    
    -- Tab Bar
    local TabBar = Util.Create("Frame", {
        Size = UDim2.new(1, -28, 0, 32),
        Position = UDim2.new(0, 14, 0, 56),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Parent = Main
    })
    
    local TabLayout = Util.Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 4),
        Parent = TabBar
    })
    
    -- Content Container
    local ContentContainer = Util.Create("ScrollingFrame", {
        Size = UDim2.new(1, -28, 1, -100),
        Position = UDim2.new(0, 14, 0, 92),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = Theme.Accent,
        ScrollBarImageTransparency = 0.4,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ScrollingDirection = Enum.ScrollingDirection.Y,
        Parent = Main
    })
    
    -- Dragging
    local dragging = false
    local dragStart, startPos
    local targetPos = Main.Position
    
    table.insert(Connections, TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
        end
    end))
    
    table.insert(Connections, TopBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end))
    
    table.insert(Connections, UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            targetPos = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end))
    
    table.insert(Connections, RunService.RenderStepped:Connect(function()
        if dragging then
            Main.Position = Main.Position:Lerp(targetPos, 0.15)
        end
    end))
    
    -- Row Divider Helper
    local function CreateRowDivider(parent)
        return Util.Create("Frame", {
            AnchorPoint = Vector2.new(0, 1),
            Size = UDim2.new(1, 0, 0, 1),
            Position = UDim2.new(0, 0, 1, 0),
            BackgroundColor3 = Theme.Separator,
            BorderSizePixel = 0,
            Parent = parent
        })
    end
    
    -- Section Creator (FIXED - now properly defined at the right scope)
    local function CreateSection(parent, sectionName)
        local section = {}
        
        local SectionFrame = Util.Create("Frame", {
            Size = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundColor3 = Theme.Secondary,
            Parent = parent
        })
        Util.Corner(SectionFrame, Theme.CornerRadius)
        Util.Stroke(SectionFrame, Theme.Border, 1)
        
        local SectionHeader = Util.Create("Frame", {
            Size = UDim2.new(1, 0, 0, 36),
            BackgroundTransparency = 1,
            Parent = SectionFrame
        })
        
        local SectionTitle = Util.Create("TextLabel", {
            Size = UDim2.new(1, -24, 1, 0),
            Position = UDim2.new(0, 12, 0, 0),
            BackgroundTransparency = 1,
            Font = Theme.FontBold,
            Text = sectionName or "Section",
            TextColor3 = Theme.TextPrimary,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = SectionHeader
        })
        
        local SectionDivider = Util.Create("Frame", {
            Size = UDim2.new(1, -24, 0, 1),
            Position = UDim2.new(0, 12, 1, 0),
            BackgroundColor3 = Theme.Separator,
            BorderSizePixel = 0,
            Parent = SectionHeader
        })
        
        local SectionContent = Util.Create("Frame", {
            Size = UDim2.new(1, -24, 0, 0),
            Position = UDim2.new(0, 12, 0, 40),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1,
            Parent = SectionFrame
        })
        
        local ContentLayout = Util.Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 0),
            Parent = SectionContent
        })
        
        -- Add bottom padding to section
        local BottomPadding = Util.Create("Frame", {
            Size = UDim2.new(1, 0, 0, 8),
            BackgroundTransparency = 1,
            LayoutOrder = 9999,
            Parent = SectionContent
        })
        
        -- Toggle Component
        function section:AddToggle(cfg)
            cfg = cfg or {}
            local toggleName = cfg.Name or "Toggle"
            local default = cfg.Default or false
            local callback = cfg.Callback or function() end
            
            local state = default
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                ClipsDescendants = false,
                ZIndex = 5,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.65, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = toggleName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local Switch = Util.Create("Frame", {
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 44, 0, 26),
                BackgroundColor3 = state and Theme.Accent or Theme.Fill,
                Parent = Row
            })
            Util.Corner(Switch, 13)
            
            local Knob = Util.Create("Frame", {
                AnchorPoint = Vector2.new(0, 0.5),
                Position = state and UDim2.new(1, -22, 0.5, 0) or UDim2.new(0, 4, 0.5, 0),
                Size = UDim2.new(0, 18, 0, 18),
                BackgroundColor3 = Theme.TextPrimary,
                Parent = Switch
            })
            Util.Corner(Knob, 9)
            
            local SwitchButton = Util.Create("TextButton", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = "",
                Parent = Switch
            })
            
            CreateRowDivider(Row)
            
table.insert(Connections, SwitchButton.MouseButton1Click:Connect(function()
    state = not state
    
    -- Smoother color transition
    Util.Tween(Switch, {
        BackgroundColor3 = state and Theme.Accent or Theme.Fill
    }, Theme.QuickSpeed)
    
    -- Bounce animation for knob
    local targetPos = state and UDim2.new(1, -22, 0.5, 0) or UDim2.new(0, 4, 0.5, 0)
    Util.Spring(Knob, {Position = targetPos}, Theme.QuickSpeed * 1.5)
    
    -- Scale pulse effect
    local originalSize = Knob.Size
    Util.Tween(Knob, {Size = UDim2.new(0, 20, 0, 20)}, Theme.QuickSpeed / 2)
    task.delay(Theme.QuickSpeed / 2, function()
        Util.Spring(Knob, {Size = originalSize}, Theme.QuickSpeed)
    end)
    
    callback(state)
end))
            
            return {
                SetState = function(_, newState)
                    state = newState
                    Util.Tween(Switch, {BackgroundColor3 = state and Theme.Accent or Theme.Fill}, Theme.QuickSpeed)
                    Knob.Position = state and UDim2.new(1, -22, 0.5, 0) or UDim2.new(0, 4, 0.5, 0)
                end,
                GetState = function()
                    return state
                end
            }
        end
        
        -- Slider Component
        function section:AddSlider(cfg)
            cfg = cfg or {}
            local sliderName = cfg.Name or "Slider"
            local min = cfg.Min or 0
            local max = cfg.Max or 100
            local default = cfg.Default or min
            local suffix = cfg.Suffix or ""
            local callback = cfg.Callback or function() end
            
            local value = math.clamp(default, min, max)
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 52),
                BackgroundTransparency = 1,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.5, 0, 0, 22),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = sliderName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local ValueLabel = Util.Create("TextLabel", {
                AnchorPoint = Vector2.new(1, 0),
                Size = UDim2.new(0.5, 0, 0, 22),
                Position = UDim2.new(1, 0, 0, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontBold,
                Text = tostring(value) .. suffix,
                TextColor3 = Theme.Accent,
                TextSize = 12,
                TextXAlignment = Enum.TextXAlignment.Right,
                Parent = Row
            })
            
            local Track = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 6),
                Position = UDim2.new(0, 0, 0, 28),
                BackgroundColor3 = Theme.Fill,
                Parent = Row
            })
            Util.Corner(Track, 3)
            
            local Fill = Util.Create("Frame", {
                Size = UDim2.new((value - min) / (max - min), 0, 1, 0),
                BackgroundColor3 = Theme.Accent,
                Parent = Track
            })
            Util.Corner(Fill, 3)
            
            local SliderKnob = Util.Create("Frame", {
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new((value - min) / (max - min), 0, 0.5, 0),
                Size = UDim2.new(0, 16, 0, 16),
                BackgroundColor3 = Theme.TextPrimary,
                ZIndex = 2,
                Parent = Track
            })
            Util.Corner(SliderKnob, 8)
            Util.Shadow(SliderKnob, 2, 0.7)
            
            local Hitbox = Util.Create("TextButton", {
                Size = UDim2.new(1, 0, 1, 20),
                Position = UDim2.new(0, 0, 0, -10),
                BackgroundTransparency = 1,
                Text = "",
                Parent = Track
            })
            
            CreateRowDivider(Row)
            
            local sliderDragging = false
            
            -- SMOOTHER SLIDER:
local function UpdateSlider(input)
    local pct = math.clamp((input.Position.X - Track.AbsolutePosition.X) / Track.AbsoluteSize.X, 0, 1)
    value = math.floor(min + (max - min) * pct)
    ValueLabel.Text = tostring(value) .. suffix
    
    -- Smooth fill animation
    Util.Tween(Fill, {Size = UDim2.new(pct, 0, 1, 0)}, Theme.QuickSpeed / 2)
    Util.Tween(SliderKnob, {Position = UDim2.new(pct, 0, 0.5, 0)}, Theme.QuickSpeed / 2)
    
    callback(value)
end
            
            table.insert(Connections, Hitbox.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    sliderDragging = true
                    UpdateSlider(input)
                end
            end))
            
            table.insert(Connections, Hitbox.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    sliderDragging = false
                end
            end))
            
            table.insert(Connections, UserInputService.InputChanged:Connect(function(input)
                if sliderDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    UpdateSlider(input)
                end
            end))
            
            return {
                SetValue = function(_, newValue)
                    value = math.clamp(newValue, min, max)
                    local pct = (value - min) / (max - min)
                    ValueLabel.Text = tostring(value) .. suffix
                    Fill.Size = UDim2.new(pct, 0, 1, 0)
                    SliderKnob.Position = UDim2.new(pct, 0, 0.5, 0)
                end,
                GetValue = function()
                    return value
                end
            }
        end
        
        -- Button Component
        function section:AddButton(cfg)
            cfg = cfg or {}
            local buttonName = cfg.Name or "Button"
            local buttonText = cfg.ButtonText or "Execute"
            local callback = cfg.Callback or function() end
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.6, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = buttonName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local Button = Util.Create("TextButton", {
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 70, 0, 28),
                BackgroundColor3 = Theme.Accent,
                Font = Theme.FontSemibold,
                Text = buttonText,
                TextColor3 = Theme.TextPrimary,
                TextSize = 11,
                AutoButtonColor = false,
                ClipsDescendants = true,
                Parent = Row
            })
            Util.Corner(Button, Theme.CornerRadiusSmall)
            
            CreateRowDivider(Row)
            
            local hovered, pressed = false, false
            
            -- BETTER HOVER ANIMATION:
local function UpdateState()
    local targetColor
    local targetSize = Button.Size
    
    if pressed then
        targetColor = Theme.AccentDark
        -- Slight scale down when pressed
        Util.Tween(Button, {
            BackgroundColor3 = targetColor,
            Size = UDim2.new(targetSize.X.Scale, targetSize.X.Offset - 2, 0, 26)
        }, Theme.QuickSpeed / 2)
    elseif hovered then
        targetColor = Theme.AccentLight
        -- Slight scale up on hover
        Util.Tween(Button, {
            BackgroundColor3 = targetColor,
            Size = UDim2.new(0, 72, 0, 30)
        }, Theme.QuickSpeed)
    else
        targetColor = Theme.Accent
        Util.Tween(Button, {
            BackgroundColor3 = targetColor,
            Size = UDim2.new(0, 70, 0, 28)
        }, Theme.QuickSpeed)
    end
end
            
            table.insert(Connections, Button.MouseEnter:Connect(function()
                hovered = true
                UpdateState()
            end))
            
            table.insert(Connections, Button.MouseLeave:Connect(function()
                hovered = false
                pressed = false
                UpdateState()
            end))
            
            table.insert(Connections, Button.MouseButton1Down:Connect(function()
                pressed = true
                UpdateState()
            end))
            
            table.insert(Connections, Button.MouseButton1Up:Connect(function()
                pressed = false
                UpdateState()
            end))
            
            table.insert(Connections, Button.MouseButton1Click:Connect(function()
                Util.Ripple(Button)
                callback()
            end))
        end
        
        -- Keybind Component
        function section:AddKeybind(cfg)
            cfg = cfg or {}
            local keybindName = cfg.Name or "Keybind"
            local default = cfg.Default or Enum.KeyCode.E
            local callback = cfg.Callback or function() end
            
            local key = default
            local binding = false
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.6, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = keybindName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local KeyButton = Util.Create("TextButton", {
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 70, 0, 28),
                BackgroundColor3 = Theme.Fill,
                Font = Theme.FontSemibold,
                Text = key.Name,
                TextColor3 = Theme.TextPrimary,
                TextSize = 10,
                AutoButtonColor = false,
                Parent = Row
            })
            Util.Corner(KeyButton, Theme.CornerRadiusSmall)
            Util.Stroke(KeyButton, Theme.Border)
            
            CreateRowDivider(Row)
            
            table.insert(Connections, KeyButton.MouseButton1Click:Connect(function()
                binding = true
                KeyButton.Text = "..."
                Util.Tween(KeyButton, {BackgroundColor3 = Theme.Accent}, Theme.QuickSpeed)
            end))
            
            table.insert(Connections, KeyButton.MouseEnter:Connect(function()
                if not binding then
                    Util.Tween(KeyButton, {BackgroundColor3 = Theme.FillHover}, Theme.QuickSpeed)
                end
            end))
            
            table.insert(Connections, KeyButton.MouseLeave:Connect(function()
                if not binding then
                    Util.Tween(KeyButton, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
                end
            end))
            
            table.insert(Connections, UserInputService.InputBegan:Connect(function(input, gpe)
                if binding and input.UserInputType == Enum.UserInputType.Keyboard then
                    key = input.KeyCode
                    KeyButton.Text = key.Name
                    binding = false
                    Util.Tween(KeyButton, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
                    callback(key)
                end
            end))
            
            return {
                SetKey = function(_, newKey)
                    key = newKey
                    KeyButton.Text = key.Name
                end,
                GetKey = function()
                    return key
                end
            }
        end
        
        -- Dropdown Component
        function section:AddDropdown(cfg)
            cfg = cfg or {}
            local dropdownName = cfg.Name or "Dropdown"
            local options = cfg.Options or {}
            local default = cfg.Default or (options[1] or "Select")
            local callback = cfg.Callback or function() end
            
            local selected = default
            local isOpen = false
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                ClipsDescendants = false,
                ZIndex = 5,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.4, 0, 0, 42),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = dropdownName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local DropButton = Util.Create("TextButton", {
                AnchorPoint = Vector2.new(1, 0),
                Position = UDim2.new(1, 0, 0, 7),
                Size = UDim2.new(0, 130, 0, 28),
                BackgroundColor3 = Theme.Fill,
                Font = Theme.FontMedium,
                Text = selected,
                TextColor3 = Theme.TextPrimary,
                TextSize = 11,
                AutoButtonColor = false,
                Parent = Row
            })
            Util.Corner(DropButton, Theme.CornerRadiusSmall)
            Util.Stroke(DropButton, Theme.Border)
            
            local Arrow = Util.Create("TextLabel", {
                AnchorPoint = Vector2.new(1, 0.5),
                Size = UDim2.new(0, 20, 1, 0),
                Position = UDim2.new(1, -4, 0.5, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontBold,
                Text = "",
                TextColor3 = Theme.TextSecondary,
                TextSize = 8,
                Parent = DropButton
            })
            
            local DropdownList = Util.Create("Frame", {
                AnchorPoint = Vector2.new(1, 0),
                Position = UDim2.new(1, 0, 0, 38),
                Size = UDim2.new(0, 130, 0, 0),
                    BackgroundColor3 = Theme.Tertiary,
                ClipsDescendants = true,
                Visible = false,
                ZIndex = 9999,  -- CHANGED FROM 10
                Parent = ScreenGui  -- CHANGED FROM Row - Now it's a child of ScreenGui directly
            })
            Util.Corner(DropdownList, Theme.CornerRadiusSmall)
            Util.Stroke(DropdownList, Theme.Border)
            
            local ListLayout = Util.Create("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 2),
                Parent = DropdownList
            })
            
            Util.Create("UIPadding", {
                PaddingTop = UDim.new(0, 4),
                PaddingBottom = UDim.new(0, 4),
                PaddingLeft = UDim.new(0, 4),
                PaddingRight = UDim.new(0, 4),
                Parent = DropdownList
            })
            
            CreateRowDivider(Row)
            
            local function CloseDropdown()
    isOpen = false
    
    -- Fade out with scale animation
    Util.Tween(DropdownList, {
        Size = UDim2.new(0, 130, 0, 0),
        BackgroundTransparency = 1
    }, Theme.QuickSpeed * 1.5)
    
    Util.Spring(Arrow, {Rotation = 0}, Theme.QuickSpeed)
    
    task.delay(Theme.QuickSpeed * 1.5, function()
        if not isOpen then
            DropdownList.Visible = false
        end
    end)
end
            
-- FIXED VERSION with better animation:
local function OpenDropdown()
    isOpen = true
    
    -- Set initial position
    local buttonPos = DropButton.AbsolutePosition
    local buttonSize = DropButton.AbsoluteSize
    DropdownList.Position = UDim2.new(0, buttonPos.X + buttonSize.X, 0, buttonPos.Y + buttonSize.Y + 2)
    DropdownList.Visible = true
    
    local targetHeight = math.min(#options * 26 + 10, 180)
    
    -- Better animation with opacity
    DropdownList.BackgroundTransparency = 1
    Util.Tween(DropdownList, {BackgroundTransparency = 0}, Theme.QuickSpeed)
    Util.Spring(DropdownList, {
        Size = UDim2.new(0, 130, 0, targetHeight)
    }, Theme.NormalSpeed * 0.8)
    
    Util.Spring(Arrow, {Rotation = 180}, Theme.QuickSpeed)
end
            
            local function PopulateOptions()
                for _, child in ipairs(DropdownList:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                
                for _, option in ipairs(options) do
                    local OptionBtn = Util.Create("TextButton", {
                        Size = UDim2.new(1, 0, 0, 24),
                        BackgroundColor3 = Theme.Fill,
                        BackgroundTransparency = 1,
                        Font = Theme.FontMedium,
                        Text = option,
                        TextColor3 = Theme.TextSecondary,
                        TextSize = 11,
                        AutoButtonColor = false,
                        ZIndex = 11,
                        Parent = DropdownList
                    })
                    Util.Corner(OptionBtn, 4)
                    
                    OptionBtn.MouseEnter:Connect(function()
                        Util.Tween(OptionBtn, {BackgroundTransparency = 0, TextColor3 = Theme.TextPrimary}, Theme.QuickSpeed)
                    end)
                    
                    OptionBtn.MouseLeave:Connect(function()
                        Util.Tween(OptionBtn, {BackgroundTransparency = 1, TextColor3 = Theme.TextSecondary}, Theme.QuickSpeed)
                    end)
                    
                    OptionBtn.MouseButton1Click:Connect(function()
                        selected = option
                        DropButton.Text = selected
                        CloseDropdown()
                        callback(selected)
                    end)
                end
            end
            
            PopulateOptions()
            
            table.insert(Connections, DropButton.MouseButton1Click:Connect(function()
                if isOpen then
                    CloseDropdown()
                else
                    OpenDropdown()
                end
            end))
            
            table.insert(Connections, DropButton.MouseEnter:Connect(function()
                Util.Tween(DropButton, {BackgroundColor3 = Theme.FillHover}, Theme.QuickSpeed)
            end))
            
            table.insert(Connections, DropButton.MouseLeave:Connect(function()
                Util.Tween(DropButton, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
            end))
            
            return {
                SetSelected = function(_, newOption)
                    selected = newOption
                    DropButton.Text = selected
                end,
                GetSelected = function()
                    return selected
                end,
                Refresh = function(_, newOptions)
                    options = newOptions
                    PopulateOptions()
                end
            }
        end
        
        -- Textbox Component
        function section:AddTextbox(cfg)
            cfg = cfg or {}
            local textboxName = cfg.Name or "Textbox"
            local default = cfg.Default or ""
            local placeholder = cfg.Placeholder or "Enter text..."
            local callback = cfg.Callback or function() end
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.35, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = textboxName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local InputFrame = Util.Create("Frame", {
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 150, 0, 28),
                BackgroundColor3 = Theme.Fill,
                Parent = Row
            })
            Util.Corner(InputFrame, Theme.CornerRadiusSmall)
            local InputStroke = Util.Stroke(InputFrame, Theme.Border)
            
            local TextInput = Util.Create("TextBox", {
                Size = UDim2.new(1, -16, 1, 0),
                Position = UDim2.new(0, 8, 0, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                PlaceholderText = placeholder,
                PlaceholderColor3 = Theme.TextTertiary,
                Text = default,
                TextColor3 = Theme.TextPrimary,
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Left,
                ClearTextOnFocus = false,
                Parent = InputFrame
            })
            
            CreateRowDivider(Row)
            
            table.insert(Connections, TextInput.Focused:Connect(function()
                Util.Tween(InputFrame, {BackgroundColor3 = Theme.FillHover}, Theme.QuickSpeed)
                Util.Tween(InputStroke, {Color = Theme.Accent}, Theme.QuickSpeed)
            end))
            
            table.insert(Connections, TextInput.FocusLost:Connect(function(enterPressed)
                Util.Tween(InputFrame, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
                Util.Tween(InputStroke, {Color = Theme.Border}, Theme.QuickSpeed)
                callback(TextInput.Text, enterPressed)
            end))
            
            return {
                SetText = function(_, newText)
                    TextInput.Text = newText
                end,
                GetText = function()
                    return TextInput.Text
                end
            }
        end
        
        -- Color Picker Component
        function section:AddColorPicker(cfg)
            cfg = cfg or {}
            local pickerName = cfg.Name or "Color"
            local default = cfg.Default or Color3.fromRGB(255, 255, 255)
            local callback = cfg.Callback or function() end
            
            local currentColor = default
            local isOpen = false
            
            local presetColors = {
                Color3.fromRGB(255, 59, 48),
                Color3.fromRGB(255, 149, 0),
                Color3.fromRGB(255, 204, 0),
                Color3.fromRGB(52, 199, 89),
                Color3.fromRGB(0, 199, 190),
                Color3.fromRGB(48, 176, 199),
                Color3.fromRGB(50, 173, 230),
                Color3.fromRGB(0, 122, 255),
                Color3.fromRGB(88, 86, 214),
                Color3.fromRGB(175, 82, 222),
                Color3.fromRGB(255, 45, 85),
                Color3.fromRGB(255, 255, 255),
            }
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1,
                ClipsDescendants = false,
                ZIndex = 4,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(0.6, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = pickerName,
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            local ColorButton = Util.Create("TextButton", {
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 44, 0, 26),
                BackgroundColor3 = currentColor,
                Text = "",
                AutoButtonColor = false,
                Parent = Row
            })
            Util.Corner(ColorButton, Theme.CornerRadiusSmall)
            Util.Stroke(ColorButton, Theme.Border)
            
            -- FIXED VERSION:
local ColorPanel = Util.Create("Frame", {
    AnchorPoint = Vector2.new(1, 0),
    Position = UDim2.new(1, 0, 0, 45),
    Size = UDim2.new(0, 180, 0, 0),
    BackgroundColor3 = Theme.Tertiary,
    ClipsDescendants = true,
    Visible = false,
    ZIndex = 9999,  -- CHANGED
    Parent = ScreenGui  -- CHANGED - Now top level
})
            Util.Corner(ColorPanel, Theme.CornerRadiusSmall)
            Util.Stroke(ColorPanel, Theme.Border)
            
            local ColorGrid = Util.Create("Frame", {
                Size = UDim2.new(1, -16, 0, 60),
                Position = UDim2.new(0, 8, 0, 8),
                BackgroundTransparency = 1,
                ZIndex = 11,
                Parent = ColorPanel
            })
            
            Util.Create("UIGridLayout", {
                CellSize = UDim2.new(0, 36, 0, 26),
                CellPadding = UDim2.new(0, 6, 0, 6),
                SortOrder = Enum.SortOrder.LayoutOrder,
                Parent = ColorGrid
            })
            
            CreateRowDivider(Row)
            
            for i, color in ipairs(presetColors) do
                local ColorOption = Util.Create("TextButton", {
                    BackgroundColor3 = color,
                    Text = "",
                    AutoButtonColor = false,
                    ZIndex = 12,
                    Parent = ColorGrid
                })
                Util.Corner(ColorOption, 4)
                
                ColorOption.MouseButton1Click:Connect(function()
                    currentColor = color
                    Util.Tween(ColorButton, {BackgroundColor3 = currentColor}, Theme.QuickSpeed)
                    callback(currentColor)
                end)
                
                ColorOption.MouseEnter:Connect(function()
                    Util.Tween(ColorOption, {Size = UDim2.new(0, 40, 0, 30)}, Theme.QuickSpeed)
                end)
                
                ColorOption.MouseLeave:Connect(function()
                    Util.Tween(ColorOption, {Size = UDim2.new(0, 36, 0, 26)}, Theme.QuickSpeed)
                end)
            end
            
local function ClosePanel()
    isOpen = false
    
    Util.Tween(ColorPanel, {
        Size = UDim2.new(0, 180, 0, 0),
        BackgroundTransparency = 1
    }, Theme.QuickSpeed * 1.5)
    
    task.delay(Theme.QuickSpeed * 1.5, function()
        if not isOpen then
            ColorPanel.Visible = false
        end
    end)
end
            
            local function OpenPanel()
                isOpen = true
                ColorPanel.Visible = true
                Util.Spring(ColorPanel, {Size = UDim2.new(0, 180, 0, 76)}, Theme.NormalSpeed)
            end
            
            table.insert(Connections, ColorButton.MouseButton1Click:Connect(function()
                if isOpen then
                    ClosePanel()
                else
                    OpenPanel()
                end
            end))
            
            return {
                SetColor = function(_, newColor)
                    currentColor = newColor
                    ColorButton.BackgroundColor3 = newColor
                end,
                GetColor = function()
                    return currentColor
                end
            }
        end
        
        -- Label Component
        function section:AddLabel(cfg)
            cfg = cfg or {}
            local text = cfg.Text or "Label"
            
            local Row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 32),
                BackgroundTransparency = 1,
                Parent = SectionContent
            })
            
            local Label = Util.Create("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = text,
                TextColor3 = Theme.TextSecondary,
                TextSize = 12,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = Row
            })
            
            return {
                SetText = function(_, newText)
                    Label.Text = newText
                end
            }
        end
        
        return section
    end
    
    -- Tab Creator (FIXED - now at proper scope level)
    local function CreateTab(name, layoutOrder, isDefault)
        local tab = {}
        
        -- Tab Button
        local TabButton = Util.Create("TextButton", {
            Size = UDim2.new(0, 0, 1, 0),
            AutomaticSize = Enum.AutomaticSize.X,
            BackgroundColor3 = Theme.Fill,
            BackgroundTransparency = 1,
            Font = Theme.FontSemibold,
            Text = "  " .. name .. "  ",
            TextColor3 = Theme.TextSecondary,
            TextSize = 12,
            AutoButtonColor = false,
            LayoutOrder = layoutOrder or 0,
            Parent = TabBar
        })
        Util.Corner(TabButton, Theme.CornerRadiusSmall)
        
        -- Tab Content
        local TabContent = Util.Create("Frame", {
            Size = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1,
            Visible = false,
            Parent = ContentContainer
        })
        
        local ContentLayout = Util.Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 8),
            Parent = TabContent
        })
        
        tab.Button = TabButton
        tab.Content = TabContent
        tab.Name = name
        
        table.insert(AllTabs, tab)
        
        -- Tab Selection
        local function SelectTab()
            if CurrentTab == tab then return end
            
            -- Deselect previous
            if CurrentTab then
                Util.Tween(CurrentTab.Button, {
                    BackgroundTransparency = 1,
                    TextColor3 = Theme.TextSecondary
                }, Theme.QuickSpeed)
                CurrentTab.Content.Visible = false
            end
            
            -- Select new
            CurrentTab = tab
            Util.Tween(TabButton, {
                BackgroundTransparency = 0,
                TextColor3 = Theme.TextPrimary
            }, Theme.QuickSpeed)
            TabContent.Visible = true
        end
        
        table.insert(Connections, TabButton.MouseButton1Click:Connect(SelectTab))
        
        table.insert(Connections, TabButton.MouseEnter:Connect(function()
            if CurrentTab ~= tab then
                Util.Tween(TabButton, {BackgroundTransparency = 0.5}, Theme.QuickSpeed)
            end
        end))
        
        table.insert(Connections, TabButton.MouseLeave:Connect(function()
            if CurrentTab ~= tab then
                Util.Tween(TabButton, {BackgroundTransparency = 1}, Theme.QuickSpeed)
            end
        end))
        
        -- Auto-select first or default tab
        if isDefault or #AllTabs == 1 then
            task.defer(SelectTab)
        end
        
        return tab
    end
    
    -- Profile Tab
    local function CreateProfileTab()
        local profileTab = CreateTab("Profile", -100, true)
        
        local ProfileContent = Util.Create("Frame", {
            Size = UDim2.new(1, 0, 0, 230),
            BackgroundTransparency = 1,
            Parent = profileTab.Content
        })
        
        -- Left Panel (Avatar)
        local LeftPanel = Util.Create("Frame", {
            Size = UDim2.new(0, 160, 1, 0),
            BackgroundColor3 = Theme.Secondary,
            Parent = ProfileContent
        })
        Util.Corner(LeftPanel, Theme.CornerRadius)
        Util.Stroke(LeftPanel, Theme.Border)
        
        local AvatarFrame = Util.Create("Frame", {
            AnchorPoint = Vector2.new(0.5, 0),
            Size = UDim2.new(0, 90, 0, 90),
            Position = UDim2.new(0.5, 0, 0, 16),
            BackgroundColor3 = Theme.Fill,
            Parent = LeftPanel
        })
        Util.Corner(AvatarFrame, Theme.CornerRadius)
        Util.Stroke(AvatarFrame, Theme.Border)
        
        local Avatar = Util.Create("ImageLabel", {
            Size = UDim2.new(1, -8, 1, -8),
            Position = UDim2.new(0, 4, 0, 4),
            BackgroundTransparency = 1,
            Image = "rbxthumb://type=AvatarHeadShot&id=" .. LocalPlayer.UserId .. "&w=420&h=420",
            Parent = AvatarFrame
        })
        Util.Corner(Avatar, 8)
        
        local DisplayName = Util.Create("TextLabel", {
            AnchorPoint = Vector2.new(0.5, 0),
            Size = UDim2.new(1, -20, 0, 18),
            Position = UDim2.new(0.5, 0, 0, 114),
            BackgroundTransparency = 1,
            Font = Theme.FontBold,
            Text = LocalPlayer.DisplayName,
            TextColor3 = Theme.TextPrimary,
            TextSize = 14,
            TextTruncate = Enum.TextTruncate.AtEnd,
            Parent = LeftPanel
        })
        
        local Username = Util.Create("TextLabel", {
            AnchorPoint = Vector2.new(0.5, 0),
            Size = UDim2.new(1, -20, 0, 14),
            Position = UDim2.new(0.5, 0, 0, 134),
            BackgroundTransparency = 1,
            Font = Theme.FontMedium,
            Text = "@" .. LocalPlayer.Name,
            TextColor3 = Theme.TextSecondary,
            TextSize = 11,
            TextTruncate = Enum.TextTruncate.AtEnd,
            Parent = LeftPanel
        })
        
        local AccentBar = Util.Create("Frame", {
            AnchorPoint = Vector2.new(0.5, 0),
            Size = UDim2.new(0, 40, 0, 3),
            Position = UDim2.new(0.5, 0, 0, 156),
            BackgroundColor3 = Theme.Accent,
            Parent = LeftPanel
        })
        Util.Corner(AccentBar, 2)
        
        -- Discord Link
        local DiscordFrame = Util.Create("Frame", {
            AnchorPoint = Vector2.new(0.5, 1),
            Size = UDim2.new(1, -20, 0, 34),
            Position = UDim2.new(0.5, 0, 1, -10),
            BackgroundColor3 = Theme.Fill,
            Parent = LeftPanel
        })
        Util.Corner(DiscordFrame, Theme.CornerRadiusSmall)
        Util.Stroke(DiscordFrame, Theme.Border)
        
        local DiscordIcon = Util.Create("TextLabel", {
            Size = UDim2.new(0, 20, 1, 0),
            Position = UDim2.new(0, 8, 0, 0),
            BackgroundTransparency = 1,
            Font = Theme.FontBold,
            Text = "DC",
            TextColor3 = Theme.TextTertiary,
            TextSize = 8,
            Parent = DiscordFrame
        })
        
        local DiscordText = Util.Create("TextLabel", {
            Size = UDim2.new(1, -34, 1, 0),
            Position = UDim2.new(0, 28, 0, 0),
            BackgroundTransparency = 1,
            Font = Theme.FontMedium,
            Text = discordInvite,
            TextColor3 = Theme.TextSecondary,
            TextSize = 10,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            Parent = DiscordFrame
        })
        
        local DiscordButton = Util.Create("TextButton", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "",
            Parent = DiscordFrame
        })
        
        local copying = false
        table.insert(Connections, DiscordButton.MouseButton1Click:Connect(function()
            if copying then return end
            copying = true
            pcall(function()
                (setclipboard or toclipboard or function() end)(discordInvite)
            end)
            
            local orig = DiscordText.Text
            DiscordText.Text = "Copied!"
            DiscordText.TextColor3 = Theme.Success
            Util.Tween(DiscordFrame, {BackgroundColor3 = Theme.AccentMuted}, Theme.QuickSpeed)
            
            task.delay(1.2, function()
                DiscordText.Text = orig
                DiscordText.TextColor3 = Theme.TextSecondary
                Util.Tween(DiscordFrame, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
                copying = false
            end)
        end))
        
        table.insert(Connections, DiscordButton.MouseEnter:Connect(function()
            if not copying then
                Util.Tween(DiscordFrame, {BackgroundColor3 = Theme.FillHover}, Theme.QuickSpeed)
            end
        end))
        
        table.insert(Connections, DiscordButton.MouseLeave:Connect(function()
            if not copying then
                Util.Tween(DiscordFrame, {BackgroundColor3 = Theme.Fill}, Theme.QuickSpeed)
            end
        end))
        
        -- Right Panel (Info)
        local RightPanel = Util.Create("Frame", {
            AnchorPoint = Vector2.new(1, 0),
            Position = UDim2.new(1, 0, 0, 0),
            Size = UDim2.new(1, -170, 1, 0),
            BackgroundColor3 = Theme.Secondary,
            Parent = ProfileContent
        })
        Util.Corner(RightPanel, Theme.CornerRadius)
        Util.Stroke(RightPanel, Theme.Border)
        
        local InfoHeader = Util.Create("TextLabel", {
            Size = UDim2.new(1, -24, 0, 22),
            Position = UDim2.new(0, 12, 0, 12),
            BackgroundTransparency = 1,
            Font = Theme.FontBold,
            Text = "Account Information",
            TextColor3 = Theme.TextPrimary,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = RightPanel
        })
        
        local InfoDivider = Util.Create("Frame", {
            Size = UDim2.new(1, -24, 0, 1),
            Position = UDim2.new(0, 12, 0, 38),
            BackgroundColor3 = Theme.Separator,
            BorderSizePixel = 0,
            Parent = RightPanel
        })
        
        local InfoList = Util.Create("Frame", {
            Size = UDim2.new(1, -24, 1, -52),
            Position = UDim2.new(0, 12, 0, 44),
            BackgroundTransparency = 1,
            Parent = RightPanel
        })
        
        Util.Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 0),
            Parent = InfoList
        })
        
        local function InfoRow(label, value)
            local row = Util.Create("Frame", {
                Size = UDim2.new(1, 0, 0, 34),
                BackgroundTransparency = 1,
                Parent = InfoList
            })
            
            Util.Create("TextLabel", {
                Size = UDim2.new(0.45, 0, 1, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = label,
                TextColor3 = Theme.TextSecondary,
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = row
            })
            
            Util.Create("TextLabel", {
                AnchorPoint = Vector2.new(1, 0),
                Size = UDim2.new(0.53, 0, 1, 0),
                Position = UDim2.new(1, 0, 0, 0),
                BackgroundTransparency = 1,
                Font = Theme.FontSemibold,
                Text = value,
                TextColor3 = Theme.TextPrimary,
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Right,
                TextTruncate = Enum.TextTruncate.AtEnd,
                Parent = row
            })
            
            Util.Create("Frame", {
                AnchorPoint = Vector2.new(0, 1),
                Size = UDim2.new(1, 0, 0, 1),
                Position = UDim2.new(0, 0, 1, 0),
                BackgroundColor3 = Theme.Separator,
                BorderSizePixel = 0,
                Parent = row
            })
        end
        
        InfoRow("User ID", tostring(LocalPlayer.UserId))
        InfoRow("Account Age", tostring(LocalPlayer.AccountAge) .. " days")
        InfoRow("Join Date", Util.FormatDate(os.time() - (LocalPlayer.AccountAge * 86400)))
        InfoRow("Current Game", Util.GetGameName())
        InfoRow("Server ID", game.JobId ~= "" and (game.JobId:sub(1, 14) .. "...") or "Studio")
        
        return profileTab
    end
    
    CreateProfileTab()
    
    -- Toggle Visibility
    table.insert(Connections, UserInputService.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode == toggleKey and not Toggling then
            Toggling = true
            UIVisible = not UIVisible
            
            if UIVisible then
                Main.Visible = true
                Main.Size = UDim2.new(0, 580, 0, 0)
                
                Util.Spring(Main, {
                    Size = UDim2.new(0, 580, 0, 380)
                }, Theme.SpringSpeed)
                
                task.delay(Theme.SpringSpeed, function()
                    Toggling = false
                end)
            else
                Util.Tween(Main, {
                    Size = UDim2.new(0, 580, 0, 0)
                }, Theme.NormalSpeed)
                
                task.delay(Theme.NormalSpeed, function()
                    if not UIVisible then
                        Main.Visible = false
                    end
                    Toggling = false
                end)
            end
        end
    end))
    
    -- API
    local API = {
        Gui = ScreenGui,
        Main = Main,
        Theme = Theme,
        
        CreateTab = function(_, name, isDefault)
            local tab = CreateTab(name, #AllTabs, isDefault)
            
            local TabAPI = {}
            
            function TabAPI:AddSection(sectionName)
                return CreateSection(tab.Content, sectionName)
            end
            
            return TabAPI
        end,
        
        SetStatus = function(_, text, color)
            StatusText.Text = text
            StatusText.TextColor3 = color or Theme.TextSecondary
            StatusDot.BackgroundColor3 = color or Theme.TextSecondary
        end,
        
        SetToggleKey = function(_, key)
            toggleKey = key
        end,
        
        SetScale = function(_, scale)
            UIScaleValue = scale
            Util.Tween(UIScale, {Scale = scale / 100}, Theme.QuickSpeed)
        end,
        
        Destroy = function(_)
            Toggling = true
            
            for _, conn in ipairs(Connections) do
                conn:Disconnect()
            end
            
            Util.Tween(MainShadow, {ImageTransparency = 1}, Theme.QuickSpeed)
            Util.Tween(MainStroke, {Transparency = 1}, Theme.QuickSpeed)
            Util.Tween(Main, {
                Size = UDim2.new(0, 540, 0, 0)
            }, Theme.NormalSpeed)
            
            task.delay(Theme.NormalSpeed + 0.1, function()
                ScreenGui:Destroy()
                _G.KovariLoaded = false
                _G.KovariInstance = nil
            end)
        end,
        
        Notify = function(_, title, message, duration)
            duration = duration or 3
            
            local NotifFrame = Util.Create("Frame", {
                AnchorPoint = Vector2.new(1, 1),
                Position = UDim2.new(1, 20, 1, -20),
                Size = UDim2.new(0, 280, 0, 70),
                BackgroundColor3 = Theme.Secondary,
                Parent = ScreenGui
            })
            Util.Corner(NotifFrame, Theme.CornerRadius)
            local NotifStroke = Util.Stroke(NotifFrame, Theme.Border, 1)
            local NotifShadow = Util.Shadow(NotifFrame, 4, 0.6)
            
            local NotifTitle = Util.Create("TextLabel", {
                Size = UDim2.new(1, -20, 0, 20),
                Position = UDim2.new(0, 10, 0, 12),
                BackgroundTransparency = 1,
                Font = Theme.FontBold,
                Text = title or "Notification",
                TextColor3 = Theme.TextPrimary,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = NotifFrame
            })
            
            local NotifMessage = Util.Create("TextLabel", {
                Size = UDim2.new(1, -20, 0, 30),
                Position = UDim2.new(0, 10, 0, 34),
                BackgroundTransparency = 1,
                Font = Theme.FontMedium,
                Text = message or "",
                TextColor3 = Theme.TextSecondary,
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextWrapped = true,
                Parent = NotifFrame
            })
            
            -- Animate in
            Util.Spring(NotifFrame, {Position = UDim2.new(1, -20, 1, -20)}, Theme.NormalSpeed)
            
            task.delay(duration, function()
                Util.Tween(NotifFrame, {Position = UDim2.new(1, 20, 1, -20)}, Theme.NormalSpeed)
                
                task.delay(Theme.NormalSpeed + 0.1, function()
                    NotifFrame:Destroy()
                end)
            end)
        end
    }
    
    -- Built-in Settings Tab
    local SettingsTab = API:CreateTab("Settings", false)
    
    local UISection = SettingsTab:AddSection("Interface")
    
    UISection:AddSlider({
        Name = "UI Scale",
        Min = 50,
        Max = 150,
        Default = 100,
        Suffix = "%",
        Callback = function(value)
            API:SetScale(value)
        end
    })
    
    UISection:AddKeybind({
        Name = "Toggle Key",
        Default = toggleKey,
        Callback = function(key)
            API:SetToggleKey(key)
        end
    })
    
    UISection:AddToggle({
        Name = "Smooth Animations",
        Default = true,
        Callback = function(state)
            if state then
                Theme.QuickSpeed = 0.12
                Theme.NormalSpeed = 0.2
                Theme.SlowSpeed = 0.35
            else
                Theme.QuickSpeed = 0.06
                Theme.NormalSpeed = 0.1
                Theme.SlowSpeed = 0.15
            end
        end
    })
    
    local UtilSection = SettingsTab:AddSection("Utility")
    
    UtilSection:AddButton({
        Name = "Copy Discord Invite",
        ButtonText = "Copy",
        Callback = function()
            pcall(function()
                (setclipboard or toclipboard or function() end)(discordInvite)
            end)
            API:Notify("Copied", "Discord invite copied to clipboard!", 2)
        end
    })
    
    UtilSection:AddButton({
        Name = "Rejoin Server",
        ButtonText = "Rejoin",
        Callback = function()
            TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
        end
    })
    
    UtilSection:AddButton({
        Name = "Server Hop",
        ButtonText = "Hop",
        Callback = function()
            local success, servers = pcall(function()
                return HttpService:JSONDecode(
                    game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")
                )
            end)
            
            if success and servers and servers.data then
                for _, server in ipairs(servers.data) do
                    if server.id ~= game.JobId then
                        TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id, LocalPlayer)
                        break
                    end
                end
            end
        end
    })
    
    local DangerSection = SettingsTab:AddSection("Danger Zone")
    
    DangerSection:AddButton({
        Name = "Destroy UI",
        ButtonText = "Destroy",
        Callback = function()
            API:Destroy()
        end
    })
    
    return API
end

-- Built-in Key System Integration
function Kovari:Load(config)
    config = config or {}
    
    if config.KeySystem then
        local keyConfig = config.KeySystem
        keyConfig.OnSuccess = function()
            self:Init(config)
        end
        keyConfig.OnFailed = keyConfig.OnFailed or function() end
        
        return self:CreateKeyUI(keyConfig)
    else
        return self:Init(config)
    end
end

-- Store instance globally
_G.KovariInstance = Kovari

return Kovari

--[[
USAGE EXAMPLE:

local Kovari = loadstring(game:HttpGet("YOUR_URL"))()

-- With Key System
local UI = Kovari:Load({
    ToggleKey = Enum.KeyCode.RightControl,
    Discord = "discord.gg/QcvddpVeTM",
    KeySystem = {
        Title = "My Script",
        Subtitle = "Premium Script",
        ServiceId = 18623,
        Secret = "your-secret-here",
        Discord = "discord.gg/QcvddpVeTM"
    }
})

-- Without Key System
local UI = Kovari:Init({
    ToggleKey = Enum.KeyCode.RightControl,
    Discord = "discord.gg/QcvddpVeTM"
})

local MainTab = UI:CreateTab("Main", true)
local Section = MainTab:AddSection("Features")

Section:AddToggle({
    Name = "Enable Feature",
    Default = false,
    Callback = function(state)
        print("Toggle:", state)
    end
})

Section:AddSlider({
    Name = "Speed",
    Min = 0,
    Max = 100,
    Default = 50,
    Suffix = "",
    Callback = function(value)
        print("Slider:", value)
    end
})

Section:AddButton({
    Name = "Click Me",
    ButtonText = "Execute",
    Callback = function()
        print("Button clicked!")
    end
})

Section:AddDropdown({
    Name = "Select Option",
    Options = {"Option 1", "Option 2", "Option 3"},
    Default = "Option 1",
    Callback = function(selected)
        print("Selected:", selected)
    end
})

Section:AddKeybind({
    Name = "Keybind",
    Default = Enum.KeyCode.E,
    Callback = function(key)
        print("New key:", key.Name)
    end
})

Section:AddTextbox({
    Name = "Input",
    Default = "",
    Placeholder = "Type here...",
    Callback = function(text, enter)
        print("Text:", text, "Enter:", enter)
    end
})

Section:AddColorPicker({
    Name = "Color",
    Default = Color3.fromRGB(255, 0, 0),
    Callback = function(color)
        print("Color:", color)
    end
})
]]
